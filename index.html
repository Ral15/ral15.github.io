<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
   
    <link href="https://fonts.googleapis.com/css?family=Muli:400,600,700,800,900" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js" integrity="sha256-oSgtFCCmHWRPQ/JmR4OoZ3Xke1Pw4v50uh6pLcu+fIc=" crossorigin="anonymous"></script>

    <title>Challenge 2</title>

    <style type="text/css">
        body {
            background-color: #FFF;
            font-family: Muli!important;
        }

        .btn:hover {
          background-color: #ACAAAA;
          color: #000;
          cursor: pointer;
        } 

        .btn {
          border-radius: 4px;
          border: solid 1px rgba(74, 74, 74, 0.07);
          /*font-size: 14px;
          text-align: center;
          color: #000;*/
        }

        .error-message {
            color: #cc162d; 
            font-size: 10px;
        }

        .center-text {
            text-align: center;
        }

    </style>
</head>

<body>

    <div class="center-text">
        <h1>Github's user's language "presence"</h1>
    </div>


    <div class="center-text">
        <label for="username">Github's username</label>
        <br>
        <input type="text" name="username" id="username">
        <button onclick="searchUser()" id="search_button" class="btn">search</button>
        <br>
        <span id="error-text" class="error-message"></span>
    </div>

    <div class="center-text" style="height: 500px; width: 500px;">
        <canvas id="myChart" width="300" height="300" style="display: inline-block!important;"></canvas>
    </div>
<script>

    const ctx_ = document.getElementById("myChart").getContext('2d');
    const url_ = 'https://api.github.com';
    

    const button_ = document.getElementById('search_button');

    let myChart_ = null;


    /**
     * Gets username from text input and displays the different 
     * languages the user has 
     *
     *
     *
     */    
    const searchUser = () => {
        const username = document.getElementById('username').value;
        console.log({username});
        let errorText = document.getElementById('error-text');
        errorText.innerHTML = '';

        if (!username) {
            errorText.innerHTML = 'Ingresa un usuario';
            return;
        }
        
        button_.disabled = true;

        myChart_ && myChart_.destroy();

        return fetchUserRepositories(username)
        .then(reposLanguagesURLs => countUserLanguages(reposLanguagesURLs))
        .then((languages) => createChart(languages))
        .catch((e) => console.log({e}));
    };


    const fetchUserRepositories = (username) => {
        return fetch(`${url_}/users/${username}/repos`, {
            headers: {
                'Accept': 'application/vnd.github.mercy-preview+json',
                'Authorization': 'token 632527a6a3e7f9046a37fe2edb788bf709c5667d'
            }
        })
        .then(response => response.json())
        .then((data) => {
            console.log({data});
            return data.filter((d) => d.language);
        })
        .then((repos) => {
            console.log({repos})
           return repos.map((d) => d.languages_url);
        })
        .then((reposLanguageUrls) => {
            return reposLanguageUrls.map(url => fetch(url, {
                headers: {
                    'Authorization': 'token 632527a6a3e7f9046a37fe2edb788bf709c5667d',
                }
            }));
        })
        .catch((e) => {
            console.log({e});
        });
    };


    /**
     * 
     *
     *
     *
     */
    const countUserLanguages = (reposLanguagesURLs) => {
        return Promise.all(reposLanguagesURLs)
        .then(responses => Promise.all(responses.map(response => response.json())))
        .then((data) => {
            console.log({data});
            let languages = {};
            let totalBytes = 0;
            for (const key in data) {
                for (const lang in data[key]) {
                    if (languages[lang]) {
                        languages[lang] += data[key][lang];
                    } else {
                        languages[lang] = data[key][lang];
                    }
                    totalBytes += data[key][lang];
                }
            }
            for (const lang in languages) {
                languages[lang] /= totalBytes;
            }
            return languages;
        })
        .catch((e) => console.log({e}));
    };
   
    const createChart = (languages) => {
        console.log({languages});
        let labels = [];
        let data = [];
        let colors = [];

        for (const language in languages) {
            labels.push(language);
            data.push(languages[language].toFixed(2)); 
            colors.push(generateRandomColor())
        }

        myChart_ = new Chart(ctx_, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'languages',
                    data: data,
                    backgroundColor: colors,
                    borderColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                title: {
                    text: 'Languages',
                    display: true,

                }
            }
        }); 
        button_.disabled = false;
    };

    
    const generateRandomColor = () => {
        return '#' + (Math.random().toString(16) + '0000000').slice(2, 8);
    };

</script>
</body>

</html>
