<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
   
    <link href="https://fonts.googleapis.com/css?family=Muli:400,600,700,800,900" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js" integrity="sha256-oSgtFCCmHWRPQ/JmR4OoZ3Xke1Pw4v50uh6pLcu+fIc=" crossorigin="anonymous"></script>

    <title>User's Github Presence</title>

    <style type="text/css">
        body {
            background-color: #FFF;
            font-family: Muli!important;
        }

        .btn:hover {
          background-color: #ACAAAA;
          color: #000;
          cursor: pointer;
        } 

        .btn {
          border-radius: 4px;
          border: solid 1px rgba(74, 74, 74, 0.07);
          padding: 3px 9px;
        }

        .error-message {
            color: #cc162d; 
            font-size: 10px;
        }

        .center-text {
            text-align: center;
        }

        #languages-chart {
            height: 500px; 
            width: 500px; 
            margin: auto;
            margin-top: 5vh;
        }

    </style>
</head>

<body>

    <div class="center-text">
        <h1>Github's user's language presence</h1>
        <p>Insert an existing Github username to see the percentage of the different languages the user has worked with.</p>
    </div>

    <div class="center-text">
        <label for="username">Github's username</label>
        <br>
        <input type="text" name="username" id="username" placeholder="mbostock">
        <button onclick="searchUser()" id="search_button" class="btn">search</button>
        <br>
        <span id="error-text" class="error-message"></span>
    </div>

    <div id="languages-chart">
        <canvas id="myChart" width="300" height="300"></canvas>
    </div>

<script>
  const ctx_ = document.getElementById('myChart').getContext('2d');
  const url_ = 'https://api.github.com';

  const token_ = 'UmFsMTU6MGUyYTRiODZlNmVmOGExOWU1YzNmYWQ3MzE4MGU4NGYyODM5M2RjMw==';
  const button_ = document.getElementById('search_button');

  let myChart_ = null;

  /**
   * Shows user a message if something went wrong.
   *
   * @param {string} message - Message wished to display to the user.
   */

  const showErrorMessage = (message = 'Error..') => {
    document.getElementById('error-text').innerHTML = message;
    button_.disabled = false;
  };

  /**
   * Gets username from text input and displays the different
   * languages the user has
   *
   *
   * @return {Promise} The main logic of the challenge.
   */

  const searchUser = () => {
    const username = document.getElementById('username').value;
    showErrorMessage('');
    if (!username) {
      showErrorMessage('Insert an username');
      return;
    }

    button_.disabled = true;

    myChart_ && myChart_.destroy();

    return fetchUserRepositories(username)
      .then(reposLanguagesURLs => countUserLanguages(reposLanguagesURLs))
      .then(languages => createChart(languages))
      .catch(e => console.log(e));
  };

  /**
   * Requests user's repositories from Github's API.
   *
   * Using Gihub's API, the list of repositories that have
   * a 'valid' language is returned given a username. A repo has
   * a 'valid' language if its value for language is not null.
   *
   * @param {string} username - Github username.
   *
   *  @return {array} Array with pending fetch promises
   */

  const fetchUserRepositories = username => {
    return fetch(`${url_}/users/${username}/repos?type=all`, {
      headers: {
        Accept: 'application/vnd.github.mercy-preview+json',
        Authorization: `Basic ${token_}`
      }
    })
      .then(response => {
        if (response.ok) {
          return response.json();
        }
        showErrorMessage(response.statusText);
        throw Error(`Request rejected with status ${response.statusText}`);
      })
      .then(data => {
        return data.filter(d => d.language);
      })
      .then(repos => {
        return repos.map(d => d.languages_url);
      })
      .then(reposLanguageUrls => {
        return reposLanguageUrls.map(url =>
          fetch(url, {
            headers: {
              Authorization: `Basic ${token_}`
            }
          }).catch(err => err)
        );
      })
      .catch(error => {
        console.log(error);
      });
  };

  /**
   * Obtains all the different languages used in a list of repos.
   *
   * Using Github's API, we obtain all of the different languages used
   * in a repo. A set with each of the different languages found on the users
   * contributions with the amount of bytes per language is created and returned.
   *
   * @param {array} reposLanguageURLs - Urls of each of the languages repos from a
   * user.
   *
   *  @return {object} Set of languages with the number of bytes.
   */

  const countUserLanguages = reposLanguagesURLs => {
    if (!reposLanguagesURLs) return;
    return Promise.all(reposLanguagesURLs)
      .then(responses => Promise.all(responses.map(response => response.json())))
      .then(data => {
        let languages = {};
        let totalBytes = 0;
        for (const key in data) {
          for (const lang in data[key]) {
            languages[lang]
              ? (languages[lang] += data[key][lang])
              : (languages[lang] = data[key][lang]);
            totalBytes += data[key][lang];
          }
        }
        for (const lang in languages) {
          languages[lang] /= totalBytes;
        }
        return languages;
      })
      .catch(e => console.log(e));
  };

  /**
   * Creates chart object.
   *
   * This method creates the chart object from the languages data,
   * as well as creating a random color for each of the different labels.
   *
   *  @param {object} Object with the languages info.
   */

  const createChart = languages => {
    if (Object.keys(languages).length == 0) {
      showErrorMessage('No valid repositories where found for this user, please try a different one.');
      return;
    }
    let labels = [];
    let data = [];
    let colors = [];

    for (const language in languages) {
      labels.push(language);
      data.push(languages[language].toFixed(2));
      colors.push(generateRandomColor());
    }

    myChart_ = new Chart(ctx_, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'languages',
            data: data,
            backgroundColor: colors,
            borderColor: colors,
            borderWidth: 1
          }
        ]
      },
      options: {
        title: {
          text: 'Presence in % of all languages the user has worked with.',
          display: true,
          position: 'bottom'
        },
        legend: {
          display: true
        }
      }
    });
    button_.disabled = false;
  };

  /**
   * Generates a random color.
   *
   *  @return {string} Randomly generated color.
   */

  const generateRandomColor = () => {
    return '#' + (Math.random().toString(16) + '0000000').slice(2, 8);
  };


</script>
</body>

</html>
